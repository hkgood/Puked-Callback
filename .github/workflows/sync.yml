name: Sync Release to Alist

on:
  release:
    types: [published]
  workflow_dispatch: # 允许你在 Actions 页面手动点击运行

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Get Release Assets
        id: get_assets
        run: |
          # 获取当前 Release 的所有文件下载链接
          # 如果是手动触发，则获取最新 (latest) 的 Release
          RELEASE_ID=${{ github.event.release.id || 'latest' }}
          ASSETS=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID | jq -r '.assets[].browser_download_url')
          echo "assets=$ASSETS" >> $GITHUB_OUTPUT

      - name: Upload to Alist via WebDAV
        run: |
          # 定义网盘挂载点
          DRIVES=("Aliyun" "Baidu")
          # 获取仓库名作为目标文件夹
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          for url in ${{ steps.get_assets.outputs.assets }}; do
            filename=$(basename $url)
            for drive in "${DRIVES[@]}"; do
              echo "正在上传 $filename 到 $drive/$REPO_NAME ..."
              
              # 使用 curl 直接流式推送
              # -u 填入你在 Secrets 设置的变量
              curl -L "$url" | curl -u "${{ secrets.ALIST_USER }}:${{ secrets.ALIST_PASSWORD }}" \
                -T - "http://115.29.162.18:5244/dav/$drive/$REPO_NAME/$filename" \
                --fail --show-error
            done
          done
